<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Sillok Web3 Demo</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.8.2/dist/web3.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2em auto; }
    label { display: block; margin-top: 1em; }
    input, button { width: 100%; padding: .5em; margin-top: .5em; }
    #status { margin-top: 1em; color: green; }
    #error  { margin-top: 1em; color: red;   }
  </style>
</head>
<body>
  <h1>MetaMask <-> WorldLand ì—°ë™</h1>

  <button id="connectBtn">ğŸ”— MetaMask ì—°ê²°</button>
  <div id="account"></div>

  <hr/>

  <h2> ìˆ˜ë™ì €ì¥: ì§ì ‘ CIDë¥¼ êµ¬í•œ ê²½ìš° </h2>
  <label>CID (IPFS)</label>
  <input type="text" id="cid" placeholder="ì˜ˆ: Qm..." />

  <label>íŒŒì¼ íƒ€ì…</label>
  <input type="text" id="fileType" placeholder="ì˜ˆ: md" />

  <label>ì‚¬ìš©ì ID</label>
  <input type="number" id="userId" placeholder="ì˜ˆ: 123" />

  <button id="sendBtn" disabled>ğŸ’¾ ë©”íƒ€ë°ì´í„° ì €ì¥</button>

  <div id="status"></div>
  <div id="error"></div>

<script>
  let web3, contract;

  const CONTRACT_ADDRESS = "0xA51c1fc2f0D1a1b8494Ed1FE312d7C3a78Ed91C0"; // truffle migrate í›„ ì‹¤ì œ ì£¼ì†Œ
  const CONTRACT_ABI = [ /* ì—¬ê¸°ì— ABI JSON ë°°ì—´ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš” */ ];

  async function init() {
    if (!window.ethereum) {
      document.getElementById('error').innerText = 'MetaMaskê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.';
      return;
    }
    web3 = new Web3(window.ethereum);

    document.getElementById('connectBtn').onclick = async () => {
      try {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        document.getElementById('account').innerText = 'ì—°ê²°ëœ ê³„ì •: ' + accounts[0];
        contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
        document.getElementById('sendBtn').disabled = false;
      } catch (err) {
        document.getElementById('error').innerText = 'ì—°ê²° ì‹¤íŒ¨: ' + err.message;
      }
    };

    document.getElementById('sendBtn').onclick = async () => {
      const cid      = document.getElementById('cid').value.trim();
      const fileType = document.getElementById('fileType').value.trim();
      const userId   = +document.getElementById('userId').value;
      const timestamp = Math.floor(Date.now() / 1000); // ì´ˆ ë‹¨ìœ„

      if (!cid || !fileType || !userId) {
        document.getElementById('error').innerText = 'ëª¨ë“  í•„ë“œë¥¼ ì±„ì›Œì£¼ì„¸ìš”.';
        return;
      }
      document.getElementById('status').innerText = 'íŠ¸ëœì­ì…˜ ëŒ€ê¸° ì¤‘â€¦';
      document.getElementById('error').innerText  = '';

      try {
        const accounts = await web3.eth.getAccounts();
        const receipt = await contract.methods
          .storeFileMetadata(cid, fileType, timestamp, false, String(userId))
          .send({ from: accounts[0] })
          .once('transactionHash', hash => {
            document.getElementById('status').innerText = 'Tx í•´ì‹œ: ' + hash;
          });
        document.getElementById('status').innerText += '\në¸”ë¡ ë²ˆí˜¸: ' + receipt.blockNumber;
      } catch (err) {
        document.getElementById('error').innerText = 'ì—ëŸ¬: ' + err.message;
      }
    };
  }

  window.addEventListener('load', init);
</script>
</body>
</html>
